# GeoTIFF to PMTiles

A memory-efficient, pure-Go tool that converts GeoTIFF/COG files into PMTiles v3 archives.

For more information on the PMTiles format, see the [PMTiles documentation](https://docs.protomaps.com/pmtiles/).

You can visualize generated PMTiles files at [pmtiles.io](https://pmtiles.io/).

Sample input data is provided in the `data/` directory (download with `wget -i data.csv`).


## Features

- **Memory-efficient**: Reads COG tiles on-demand via memory-mapped I/O; never loads entire rasters into memory (~15-20 MB peak for typical workloads vs multi-GB for alternatives)
- **Pure Go**: No CGo or GDAL dependency; all encodings including WebP work without system libraries
- **Multiple encodings**: JPEG, PNG, WebP, and Terrarium (for elevation/DEM data)
- **Auto zoom detection**: Calculates maximum zoom level from source resolution
- **Auto float detection**: Automatically selects Terrarium encoding for float GeoTIFF input (elevation data)
- **Parallel processing**: Concurrent tile generation with configurable worker pool
- **PMTiles v3**: Writes spec-compliant archives with Hilbert-curve tile ordering
- **COG-aware**: Exploits Cloud Optimized GeoTIFF overview levels for lower zoom tiles
- **Lanczos-3 resampling**: High-quality sinc-windowed interpolation (6Ã—6 kernel) as default, with bilinear and nearest-neighbor also available
- **Pyramid downsampling**: Lower zoom tiles are generated by downsampling higher zoom tiles for efficiency

## Supported Input

- GeoTIFF / Cloud Optimized GeoTIFF (COG) files
- TIFF compression: JPEG, LZW, Deflate/Zlib, and uncompressed
- Sample formats: 8-bit RGB/RGBA, Float32/Float64 (for elevation/DEM data)
- Source CRS: EPSG:2056 (Swiss LV95), EPSG:4326 (WGS84), EPSG:3857 (Web Mercator)
- Extensible projection interface for adding additional CRS support

## Installation

```bash
go build -o geotiff2pmtiles ./cmd/geotiff2pmtiles/
```

Or using the Makefile:

```bash
make build
```

### Cross-compilation

Build for all supported platforms (Linux, macOS):

```bash
make cross-all
```

Or target a specific platform:

```bash
make cross-linux          # Linux amd64
make cross-linux-arm64    # Linux arm64
make cross-darwin         # macOS amd64
make cross-darwin-arm64   # macOS arm64
```

## Usage

```
geotiff2pmtiles [flags] <input-dir-or-files...> <output.pmtiles>
```

### Flags

| Flag            | Default       | Description                                        |
| --------------- | ------------- | -------------------------------------------------- |
| `--format`      | `jpeg`        | Tile encoding: `jpeg`, `png`, `webp`, `terrarium`  |
| `--quality`     | `85`          | JPEG/WebP quality (1-100)                          |
| `--min-zoom`    | auto          | Minimum zoom level (default: max_zoom - 6)         |
| `--max-zoom`    | auto          | Maximum zoom level (auto-detected from resolution) |
| `--tile-size`   | `256`         | Output tile size in pixels                         |
| `--concurrency` | `NumCPU`      | Number of parallel workers                         |
| `--resampling`  | `lanczos`     | Interpolation method: `lanczos`, `bilinear`, `nearest` |
| `--verbose`     | `false`       | Verbose progress output                            |
| `--version`     |               | Print version and exit                             |
| `--cpuprofile`  |               | Write CPU profile to file                          |
| `--memprofile`  |               | Write memory profile to file                       |

### Examples

Convert a directory of GeoTIFFs with auto zoom detection:

```bash
./geotiff2pmtiles --verbose data/ output.pmtiles
```

Convert specific files with custom zoom range and PNG format:

```bash
./geotiff2pmtiles --format png --min-zoom 10 --max-zoom 18 \
  file1.tif file2.tif output.pmtiles
```

High-quality WebP with bilinear resampling:

```bash
./geotiff2pmtiles --format webp --quality 95 --resampling bilinear \
  data/ output.pmtiles
```

Elevation data (auto-detects float GeoTIFF and selects Terrarium encoding):

```bash
./geotiff2pmtiles --verbose dem/ elevation.pmtiles
```

## Utilities

### coginfo

Inspect COG file metadata (EPSG, dimensions, pixel size, bounds, overview levels):

```bash
go run ./cmd/coginfo/ <file.tif>
```

### debug

Low-level COG debugging (float detection, NoData values, raw IFD info, sample tile bytes):

```bash
go run ./cmd/debug/ <file.tif>
```

## Architecture

```
cmd/
  geotiff2pmtiles/main.go          CLI entry point
  coginfo/main.go                   COG metadata inspector
  debug/main.go                     Low-level COG debug utility
internal/
  cog/
    reader.go                       COG/GeoTIFF tile-level reader (memory-mapped)
    ifd.go                          TIFF IFD parser
    geotags.go                      GeoTIFF metadata extraction
    tilecache.go                    LRU tile cache for decoded source tiles
    lzw.go                          LZW decompression
  coord/
    swiss.go                        EPSG:2056 <-> WGS84 transforms
    mercator.go                     WGS84 <-> Web Mercator tile math
    projection.go                   Extensible projection interface
    hilbert.go                      Hilbert curve for spatial tile ordering
  tile/
    generator.go                    Parallel tile generation pipeline
    resample.go                     Lanczos/bilinear/nearest interpolation + reprojection
    downsample.go                   Pyramid downsampling for lower zoom levels
    zoom.go                         Zoom level auto-calculation
    progress.go                     Progress reporting
  encode/
    encoder.go                      Unified encoding interface
    jpeg.go                         JPEG encoder
    png.go                          PNG encoder
    webp.go                         WebP encoder (pure Go via gen2brain/webp)
    terrarium.go                    Terrarium encoder for elevation data
  pmtiles/
    writer.go                       PMTiles v3 two-pass writer with tile clustering
    header.go                       Header serialization (127 bytes)
    directory.go                    Hilbert-curve tile IDs + directory compression
```

### Pipeline

1. **Scan**: Collect and open GeoTIFF/COG input files
2. **Metadata**: Parse GeoTIFF tags for CRS, bounds, and resolution
3. **Plan**: Compute merged WGS84 bounds and zoom range; auto-detect float data
4. **Generate (max zoom)**: Enumerate tiles, sort by Hilbert curve, distribute to worker pool
5. **Reproject**: Per-pixel inverse projection from output tile to source CRS
6. **Resample**: Lanczos-3, bilinear, or nearest-neighbor interpolation from source COG tiles (cached)
7. **Downsample (lower zooms)**: Combine 4 child tiles into parent tiles via pyramid downsampling
8. **Encode**: JPEG/PNG/WebP/Terrarium encoding
9. **Write**: Two-pass PMTiles assembly (temp file for tile data, then final archive with clustering)

### Memory Efficiency

- Memory-mapped file access (no full-image decode)
- LRU tile cache prevents redundant reads (~256 tiles, configurable)
- Worker buffers are bounded by concurrency setting
- PMTiles writer uses temp file for tile data (only directory entries in memory)
- Pyramid downsampling avoids redundant source reads for lower zoom levels
- Typical peak memory: 15-20 MB for 36 input files at z14-z20

## Performance

The render pipeline has been profiled and optimized for throughput. Key optimizations and their measured impact (36 Swiss LV95 COGs, z10-16, 512px tiles, WebP encoding, Apple M-series):

| Optimization | Technique | CPU reduction |
| --- | --- | --- |
| Precompute lon/lat | Web Mercator lon is linear with px, lat depends only on py; precompute per-row/col instead of per-pixel trig (Atan, Sinh) | O(n^2) -> O(n) trig calls |
| Tile-level pixel extraction | `pixelFromImage` type-switch (YCbCr, RGBA) avoids `image.At()` interface boxing and `Point.In` bounds checks | ~18% of baseline eliminated |
| Bilinear tile reuse | `fetchTileCached` fetches 1-2 tiles instead of 4 per-pixel cache lookups for bilinear interpolation | ~35% of baseline eliminated |
| RWMutex tile cache | `sync.RWMutex` on cache shards allows concurrent readers | 82% reduction in cache lock time |
| Bit-shift pow2 | `pow2(z)` via bit shift replaces `math.Pow(2, float64(z))` in all Mercator functions | ~4% of baseline eliminated |
| Package-level clampByte | Moved out of closure so the compiler can inline it | Enables inlining |
| Direct Pix writes | Write to `img.Pix[]` directly instead of `img.SetRGBA()` | Eliminates bounds checks |

**End-to-end result**: ~24% wall-time speedup (8.1s -> 6.3s median), 43% CPU reduction, with byte-identical output (verified via SHA-256).

After optimization, the remaining CPU budget is dominated by the WebP WASM encoder (~41%), JPEG tile decoding, and irreducible projection math (`SwissLV95.FromWGS84`).

### Profiling

```bash
make demo-profile                          # Run with CPU + memory profiling
go tool pprof -http=:8080 dist/cpu.prof    # Interactive flame graph
go tool pprof -http=:8081 dist/mem.prof    # Memory profile
```

## Adding New Projections

Implement the `coord.Projection` interface:

```go
type Projection interface {
    ToWGS84(x, y float64) (lon, lat float64)
    FromWGS84(lon, lat float64) (x, y float64)
    EPSG() int
}
```

Then register it in `coord.ForEPSG()`.

## License

MIT
