# GeoTIFF to PMTiles

A memory-efficient, pure-Go tool that converts GeoTIFF/COG files into PMTiles v3 archives.

For more information on the PMTiles format, see the [PMTiles documentation](https://docs.protomaps.com/pmtiles/).

You can visualize generated PMTiles files at [pmtiles.io](https://pmtiles.io/).

Sample input data is provided in the `data/` directory (download with `wget -i data.csv`).
A second sample directory `data_tfw/` supports plain TIFFs with TFW sidecar files (see `data_tfw/README.md`).


## Features

- **Memory-efficient**: Reads COG tiles on-demand via memory-mapped I/O; never loads entire rasters into memory
- **Disk-backed tile store**: Tiles are stored in encoded form (5-25x smaller than raw pixels) and continuously spilled to disk via a dedicated I/O goroutine with configurable memory backpressure
- **Pure Go**: No CGo or GDAL dependency; all encodings including WebP work without system libraries
- **Multiple encodings**: JPEG, PNG, WebP, and Terrarium (for elevation/DEM data)
- **Auto zoom detection**: Calculates maximum zoom level from source resolution
- **Auto float detection**: Automatically selects Terrarium encoding for float GeoTIFF input (elevation data)
- **Coverage gap detection**: Warns about geographic holes in input file coverage
- **Parallel processing**: Concurrent tile generation with configurable worker pool and Hilbert-curve batch scheduling for spatial locality
- **PMTiles v3**: Writes spec-compliant archives with Hilbert-curve tile ordering
- **COG-aware**: Exploits Cloud Optimized GeoTIFF overview levels for lower zoom tiles
- **Lanczos-3 resampling**: High-quality sinc-windowed interpolation (6×6 kernel) as default, with bilinear and nearest-neighbor also available; optimized with precomputed LUT and batched tile fetches
- **Pyramid downsampling**: Lower zoom tiles are generated by downsampling higher zoom tiles, with gray-aware fast path for single-channel data (15x faster)
- **Uniform tile compaction**: Single-color tiles stored as 4 bytes each, never spilled to disk

## Supported Input

- GeoTIFF / Cloud Optimized GeoTIFF (COG) files
- Plain TIFF with TFW (TIFF World File) sidecar for georeferencing
- Strip-based and tiled TIFF layouts
- TIFF compression: JPEG, LZW, Deflate/Zlib, and uncompressed (with predictor support)
- Sample formats: 8-bit RGB/RGBA, Float32/Float64 (for elevation/DEM data)
- Source CRS: EPSG:2056 (Swiss LV95), EPSG:4326 (WGS84), EPSG:3857 (Web Mercator)
- Extensible projection interface for adding additional CRS support

## Installation

```bash
go build -o geotiff2pmtiles ./cmd/geotiff2pmtiles/
```

Or using the Makefile:

```bash
make build
```

### Cross-compilation

Build for all supported platforms (Linux, macOS):

```bash
make cross-all
```

Or target a specific platform:

```bash
make cross-linux          # Linux amd64
make cross-linux-arm64    # Linux arm64
make cross-darwin         # macOS amd64
make cross-darwin-arm64   # macOS arm64
```

## Usage

```
geotiff2pmtiles [flags] <input-dir-or-files...> <output.pmtiles>
```

### Flags

| Flag            | Default       | Description                                        |
| --------------- | ------------- | -------------------------------------------------- |
| `--format`      | `jpeg`        | Tile encoding: `jpeg`, `png`, `webp`, `terrarium`  |
| `--quality`     | `85`          | JPEG/WebP quality (1-100)                          |
| `--min-zoom`    | auto          | Minimum zoom level (default: max_zoom - 6)         |
| `--max-zoom`    | auto          | Maximum zoom level (auto-detected from resolution) |
| `--tile-size`   | `256`         | Output tile size in pixels                         |
| `--concurrency` | `NumCPU`      | Number of parallel workers                         |
| `--resampling`  | `lanczos`     | Interpolation method: `lanczos`, `bilinear`, `nearest` |
| `--mem-limit`   | auto          | Tile store memory limit in MB before disk spilling (0 = auto ~90% of RAM) |
| `--no-spill`    | `false`       | Disable disk spilling (keep all tiles in memory)   |
| `--verbose`     | `false`       | Verbose progress output                            |
| `--version`     |               | Print version and exit                             |
| `--cpuprofile`  |               | Write CPU profile to file                          |
| `--memprofile`  |               | Write memory profile to file                       |

### Examples

Convert a directory of GeoTIFFs with auto zoom detection:

```bash
./geotiff2pmtiles --verbose data/ output.pmtiles
```

Convert specific files with custom zoom range and PNG format:

```bash
./geotiff2pmtiles --format png --min-zoom 10 --max-zoom 18 \
  file1.tif file2.tif output.pmtiles
```

High-quality WebP with bilinear resampling:

```bash
./geotiff2pmtiles --format webp --quality 95 --resampling bilinear \
  data/ output.pmtiles
```

Elevation data (auto-detects float GeoTIFF and selects Terrarium encoding):

```bash
./geotiff2pmtiles --verbose dem/ elevation.pmtiles
```

Convert a plain TIFF with TFW world file (global Natural Earth data):

```bash
./geotiff2pmtiles --format webp --max-zoom 6 data_tfw/ output.pmtiles
```

## Utilities

### coginfo

Inspect COG file metadata (EPSG, dimensions, pixel size, bounds, overview levels):

```bash
go run ./cmd/coginfo/ <file.tif>
```

### debug

Low-level COG debugging (float detection, NoData values, raw IFD info, sample tile bytes):

```bash
go run ./cmd/debug/ <file.tif>
```

## Architecture

See [ARCHITECTURE.md](ARCHITECTURE.md) for the full project structure, pipeline description, memory efficiency details, and how to add new projections.

## Performance

The render pipeline has been profiled and optimized for throughput across multiple rounds.

### Lanczos-3 resampling optimization

Workload: 4690 tiles (36 Swiss LV95 COGs, z12-18, 512px WebP q85, concurrency 4):

| Optimization | Technique | Reduction |
| --- | --- | --- |
| Batched tile fetches | 6×6 kernel spans at most 4 tiles; fetch each once instead of 36 cache lookups per pixel | 58x cache lookup reduction |
| Lanczos kernel LUT | 1024-entry precomputed table with linear interpolation replaces 12 `math.Sin` calls per pixel | 16x kernel eval reduction |
| YCbCr fast path | Single type assertion when all 36 pixels fall in one tile; inline YCbCr→RGB conversion | 33x pixel extraction reduction |

**Result**: 4.7x wall-time speedup (7m15s to 1m32s), 5.2x CPU reduction. Final profile is balanced across YCbCr accumulation (29%), Lanczos sampling (44% cumulative), and downsampling (8%).

### Earlier pipeline optimizations

Measured impact (36 Swiss LV95 COGs, z10-16, 512px WebP, Apple M-series):

| Optimization | Technique | CPU reduction |
| --- | --- | --- |
| Precompute lon/lat | Web Mercator lon is linear with px, lat depends only on py; precompute per-row/col instead of per-pixel trig (Atan, Sinh) | O(n^2) -> O(n) trig calls |
| Tile-level pixel extraction | `pixelFromImage` type-switch (YCbCr, RGBA) avoids `image.At()` interface boxing and `Point.In` bounds checks | ~18% of baseline eliminated |
| Bilinear tile reuse | `fetchTileCached` fetches 1-2 tiles instead of 4 per-pixel cache lookups for bilinear interpolation | ~35% of baseline eliminated |
| RWMutex tile cache | `sync.RWMutex` on cache shards allows concurrent readers | 82% reduction in cache lock time |
| Bit-shift pow2 | `pow2(z)` via bit shift replaces `math.Pow(2, float64(z))` in all Mercator functions | ~4% of baseline eliminated |
| Package-level clampByte | Moved out of closure so the compiler can inline it | Enables inlining |
| Direct Pix writes | Write to `img.Pix[]` directly instead of `img.SetRGBA()` | Eliminates bounds checks |

**Result**: ~24% wall-time speedup (8.1s to 6.3s median), 43% CPU reduction, with byte-identical output (verified via SHA-256).

### Profiling

```bash
make demo-profile                          # Run with CPU + memory profiling
go tool pprof -http=:8080 dist/cpu.prof    # Interactive flame graph
go tool pprof -http=:8081 dist/mem.prof    # Memory profile
```

## License

MIT
